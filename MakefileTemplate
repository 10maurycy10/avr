# Settings for hardware and interface
TARGET?=atmega328p
PROGRAMER?=avrisp2
F_CPU?=1000000

# All object files in program
OBJ=

# Stuff no one worres about until it is a problem
CFLAGS?=-Os -Wall -DF_CPU=$(F_CPU) -mmcu=$(TARGET)
CC=avr-gcc
SIZE=avr-size -C

# Default target, build and print flash usage
.DEFAULT_GOAL := default
default: all.elf size

# Generic rule for compiling C files
%.c.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

# Link all objects into final binary
all.elf: $(OBJ)
	$(CC) $(CFLAGS) -o all.elf $(OBJ)

# Remove build artifacts
clean:
	rm all.elf $(OBJ)

# Display rom ussage
size: all.elf
	$(SIZE) --mcu=$(TARGET) all.elf

# Shortcuts for flashing rom
flash: all.elf
	avrdude -c $(PROGRAMER) -p $(TARGET) -U flash:w:all.elf -e

flashkeep: all.elf
	avrdude -c $(PROGRAMER) -p $(TARGET) -U flash:r:dump.hex
	avrdude -c $(PROGRAMER) -p $(TARGET) -U flash:w:all.elf -U eeprom:w:dump.hex

